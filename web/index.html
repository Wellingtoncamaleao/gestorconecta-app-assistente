<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well-dev | Assistente IA</title>
    <link rel="stylesheet" href="assets/css/estilo.css">
</head>
<body>
    <div id="app">
        <header>
            <h1>Well-dev</h1>
            <span id="status">Carregando...</span>
        </header>

        <nav>
            <button class="aba ativa" data-aba="conversas">Conversas</button>
            <button class="aba" data-aba="memoria">Memoria</button>
            <button class="aba" data-aba="logs">Logs</button>
        </nav>

        <!-- CONVERSAS -->
        <section id="painel-conversas" class="painel ativo">
            <div id="lista-sessoes"></div>
            <div id="detalhe-sessao">
                <div id="mensagens"></div>
                <form id="form-enviar">
                    <input type="text" id="input-mensagem" placeholder="Enviar mensagem via web..." autocomplete="off">
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </section>

        <!-- MEMORIA -->
        <section id="painel-memoria" class="painel">
            <div id="lista-memoria"></div>
        </section>

        <!-- LOGS -->
        <section id="painel-logs" class="painel">
            <div id="lista-logs"></div>
        </section>
    </div>

    <script>
    // ========================================
    // CONFIG
    // ========================================

    const SUPABASE_URL = ''; // preencher
    const SUPABASE_KEY = ''; // preencher (anon key para web)

    async function supabaseFetch(caminho) {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/${caminho}`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
            }
        });
        return resp.json();
    }

    // ========================================
    // ESTADO
    // ========================================

    let sessaoAtiva = null;

    // ========================================
    // ABAS
    // ========================================

    document.querySelectorAll('.aba').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.aba').forEach(b => b.classList.remove('ativa'));
            document.querySelectorAll('.painel').forEach(p => p.classList.remove('ativo'));
            this.classList.add('ativa');
            document.getElementById('painel-' + this.dataset.aba).classList.add('ativo');
        });
    });

    // ========================================
    // CONVERSAS
    // ========================================

    async function carregarSessoes() {
        const sessoes = await supabaseFetch(
            'assistente_sessoes?order=ultima_mensagem_em.desc&limit=20'
        );

        const lista = document.getElementById('lista-sessoes');
        lista.innerHTML = sessoes.map(s => `
            <div class="sessao-item ${sessaoAtiva === s.id ? 'ativa' : ''}"
                 onclick="selecionarSessao('${s.id}')">
                <span class="canal">${s.canal}</span>
                <span class="titulo">${s.titulo || 'Sessao ' + s.id.slice(0, 8)}</span>
                <span class="data">${new Date(s.ultima_mensagem_em).toLocaleString('pt-BR')}</span>
                <span class="msgs">${s.total_mensagens} msgs</span>
            </div>
        `).join('');
    }

    async function selecionarSessao(id) {
        sessaoAtiva = id;
        carregarSessoes(); // re-render lista

        const msgs = await supabaseFetch(
            `assistente_mensagens?sessao_id=eq.${id}&order=criado_em.asc&limit=100`
        );

        const container = document.getElementById('mensagens');
        container.innerHTML = msgs.map(m => `
            <div class="msg ${m.direcao}">
                <span class="autor">${m.direcao === 'recebida' ? 'Wellington' : 'Well-dev'}</span>
                <pre>${escapeHtml(m.conteudo)}</pre>
                <span class="hora">${new Date(m.criado_em).toLocaleTimeString('pt-BR')}</span>
            </div>
        `).join('');

        container.scrollTop = container.scrollHeight;
    }

    // ========================================
    // MEMORIA
    // ========================================

    async function carregarMemoria() {
        const memorias = await supabaseFetch(
            'assistente_memoria?order=categoria.asc,chave.asc'
        );

        const lista = document.getElementById('lista-memoria');
        lista.innerHTML = memorias.map(m => `
            <div class="memoria-item">
                <span class="categoria">${m.categoria}</span>
                <span class="chave">${m.chave}</span>
                <span class="valor">${escapeHtml(m.valor)}</span>
            </div>
        `).join('');
    }

    // ========================================
    // LOGS
    // ========================================

    async function carregarLogs() {
        const logs = await supabaseFetch(
            'assistente_logs?order=criado_em.desc&limit=50'
        );

        const lista = document.getElementById('lista-logs');
        lista.innerHTML = logs.map(l => `
            <div class="log-item nivel-${l.nivel}">
                <span class="hora">${new Date(l.criado_em).toLocaleTimeString('pt-BR')}</span>
                <span class="nivel">${l.nivel}</span>
                <span class="componente">${l.componente}</span>
                <span class="mensagem">${escapeHtml(l.mensagem)}</span>
            </div>
        `).join('');
    }

    // ========================================
    // UTILIDADES
    // ========================================

    function escapeHtml(texto) {
        const div = document.createElement('div');
        div.textContent = texto;
        return div.innerHTML;
    }

    // ========================================
    // INICIALIZACAO
    // ========================================

    async function iniciar() {
        document.getElementById('status').textContent = 'Online';
        await carregarSessoes();
        await carregarMemoria();
        await carregarLogs();

        // Auto-refresh a cada 10s
        setInterval(carregarSessoes, 10000);
        setInterval(carregarLogs, 15000);
    }

    if (SUPABASE_URL && SUPABASE_KEY) {
        iniciar();
    } else {
        document.getElementById('status').textContent = 'Configurar SUPABASE_URL e SUPABASE_KEY';
    }
    </script>
</body>
</html>